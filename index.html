<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¡ç¥åˆ° â€§ æ—¥æœ¬é¢¨ AI æ™ºæ…§æŠ½çç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --gold: #FFD700;
            --crimson: #8B0000;
            --bright-red: #D32F2F;
        }

        body {
            background-color: var(--crimson);
            background-image: radial-gradient(circle, #b71c1c 0%, #5f0000 100%);
            color: white;
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .gold-text {
            color: var(--gold);
            text-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        #wheel-container {
            position: relative;
            width: 90vw;
            max-width: 600px;
            aspect-ratio: 1 / 1;
            margin: 20px auto;
        }

        canvas {
            width: 100%;
            height: 100%;
            border: 12px solid var(--gold);
            border-radius: 50%;
            box-shadow: 0 0 50px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.3);
            transition: transform 6s cubic-bezier(0.15, 0, 0.15, 1);
        }

        .pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 80px;
            z-index: 20;
            filter: drop-shadow(0 4px 10px rgba(0,0,0,0.5));
        }

        .btn-spin {
            background: linear-gradient(180deg, #FFEB3B 0%, #FBC02D 100%);
            border: none;
            box-shadow: 0 8px 0 #C49000, 0 15px 25px rgba(0,0,0,0.3);
            transition: all 0.1s;
        }

        .btn-spin:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #C49000, 0 5px 15px rgba(0,0,0,0.3);
        }

        #overlay {
            display: none;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .celebration-icon {
            font-size: 100px;
            animation: bounce 0.6s infinite alternate;
        }

        @keyframes bounce {
            from { transform: scale(0.8); }
            to { transform: scale(1.2); }
        }

        /* ä¿®å¾©å¾Œå°æŒ‰éˆ•å±¤ç´š */
        .admin-trigger {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 120px;
            height: 120px;
            background: transparent;
            opacity: 0;
            z-index: 9999; 
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            padding: 1.5rem;
            border-radius: 1rem;
            width: 95%;
            max-width: 550px;
            z-index: 2000;
            max-height: 85vh;
            overflow-y: auto;
            border: 2px solid var(--gold);
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--gold);
            border-radius: 50%;
            display: inline-block;
            animation: typing 1s infinite ease-in-out;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        input {
            color: #fff;
            background: #333;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <header class="text-center my-6">
        <h1 class="text-4xl md:text-6xl font-black gold-text mb-2">ğŸ§§ è²¡ç¥æŠ½å¤§ç ğŸ§§</h1>
        <p class="text-lg text-yellow-100 opacity-80">æ—¥æœ¬å¼æ…¶ç¥ â€§ AI æ™ºæ…§éˆç±¤</p>
    </header>

    <div id="wheel-container">
        <svg class="pointer" viewBox="0 0 100 120">
            <path d="M50 120 L0 20 A50 50 0 1 1 100 20 Z" fill="#FFD700" stroke="#B8860B" stroke-width="2"/>
            <circle cx="50" cy="40" r="10" fill="#D32F2F" />
        </svg>
        <canvas id="wheelCanvas" width="800" height="800"></canvas>
    </div>

    <div class="mt-4 w-full max-w-md text-center">
        <button id="spinBtn" onclick="initiateSpin()" class="btn-spin w-full py-5 px-10 rounded-full text-3xl font-bold text-red-900 shadow-2xl">
            é»æˆ‘æŠ½å¥½é‹
        </button>
        <div id="statusMessage" class="mt-4 text-xl font-semibold text-yellow-400 h-8"></div>
    </div>

    <!-- ä¸­çå½ˆçª— -->
    <div id="overlay" class="fixed inset-0 flex flex-col items-center justify-center p-6 text-center overflow-y-auto">
        <div class="celebration-icon" id="resultIcon">ğŸŠ</div>
        <h2 class="text-6xl font-black gold-text mt-6 mb-2" id="winTitle">æ­å–œä¸­çï¼</h2>
        <p id="winPrizeName" class="text-4xl text-white font-bold mb-4"></p>
        
        <!-- AI è²¡ç¥éˆç±¤å€ -->
        <div class="bg-red-900/60 border border-yellow-600/40 p-4 rounded-xl max-w-sm mb-6 shadow-inner">
            <h4 class="text-yellow-500 font-bold mb-2">âœ¨ è²¡ç¥çˆºéˆç±¤æ‰¹ç®— âœ¨</h4>
            <div id="aiFortune" class="text-lg text-yellow-100 italic leading-relaxed px-2">
                æ­£åœ¨ææŒ‡ä¸€ç®—...
                <div class="flex justify-center gap-1 mt-2">
                    <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
                </div>
            </div>
        </div>

        <button onclick="closeOverlay()" class="bg-yellow-500 hover:bg-yellow-400 text-red-900 font-bold py-4 px-12 rounded-full text-2xl transition-all hover:scale-105 active:scale-95 shadow-xl">
            è¬ä¸»éš†æ©
        </button>
    </div>

    <!-- éš±è—å¾Œå°è§¸ç™¼é» -->
    <div class="admin-trigger" onclick="adminCounter()"></div>

    <!-- ç®¡ç†å¾Œå° -->
    <div id="adminModal" class="modal shadow-2xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold gold-text">çé …èˆ‡æ¯”ä¾‹ç®¡ç†</h3>
            <button onclick="closeAdmin()" class="text-gray-400 text-3xl">&times;</button>
        </div>
        
        <div class="bg-blue-900/30 p-3 rounded mb-4 border border-blue-500/30">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span class="text-blue-300 font-bold">âœ¨ AI çé …éˆæ„Ÿ</span>
                    <span id="apiStatus" class="text-[10px] bg-gray-600 px-1 rounded text-white font-mono">ç©©å®šç‰ˆ Flash</span>
                </div>
                <button onclick="getAiSuggestions()" class="bg-blue-600 hover:bg-blue-500 text-xs py-1 px-3 rounded text-white">ç”Ÿæˆéˆæ„Ÿ</button>
            </div>
            <p id="aiSuggestionOutput" class="text-xs text-gray-400 leading-tight">ä¸çŸ¥é“è¦è¨­ä»€éº¼çï¼Ÿé»æ“Šç”Ÿæˆçœ‹çœ‹ã€‚</p>
        </div>

        <div id="adminList" class="space-y-3"></div>
        
        <div class="mt-6 flex gap-2">
            <button onclick="saveAdminData()" class="flex-1 bg-green-600 py-3 rounded font-bold text-white shadow-lg">å„²å­˜è¨­å®š</button>
            <button onclick="closeAdmin()" class="flex-1 bg-gray-700 py-3 rounded font-bold text-white">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- éŸ³æ•ˆè³‡æº - é‡æ–°é¸æ“‡æ›´éœ‡æ’¼çš„ç´ æ -->
    <!-- è½‰å‹•è²ï¼šæ©Ÿæ¢°é½’è¼ªæ„Ÿ -->
    <audio id="spinSfx" src="https://assets.mixkit.co/active_storage/sfx/2005/2005-preview.mp3" preload="auto"></audio>
    <!-- ä¸­çè²ï¼šéœ‡æ’¼æ—¥æœ¬æ–éˆ´èˆ‡æ­¡å‘¼ (Grand Fanfare) -->
    <audio id="winSfx" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" preload="auto"></audio>
    <!-- è½é¸è²ï¼šæ»‘ç¨½ä¸”èª‡å¼µ (Comical Fail) -->
    <audio id="sadSfx" src="https://assets.mixkit.co/active_storage/sfx/255/255-preview.mp3" preload="auto"></audio>

    <script>
        // --- Gemini API ---
        const apiKey = "AIzaSyAK-ZGGxlPvM83SwdDEtaBK_3C7yS-WKvw"; 
        
        async function callGemini(prompt, systemPrompt = "") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (e) {
                console.error("Gemini Error:", e);
                return "ã€è²¡ç¥çˆºéˆç±¤ã€‘ï¼šä»Šæ—¥é´»é‹ç•¶é ­ï¼Œå¤§çå³å°‡é™è‡¨ï¼ä¿æŒå¹³å¸¸å¿ƒï¼Œå¥½é‹è‡ªç„¶ä¾†ã€‚æ­å–œæ­å–œï¼";
            }
        }

        let prizes = [
            { name: "iPhone 16 Pro", count: 1, color: "#D4AF37", weight: 2 },
            { name: "ç¾é‡‘ 8888", count: 3, color: "#E91E63", weight: 8 },
            { name: "è¶…å¸‚ç¦®åˆ¸", count: 10, color: "#4CAF50", weight: 15 },
            { name: "å“ç‰Œä¿æº«ç“¶", count: 20, color: "#2196F3", weight: 25 },
            { name: "è²¡ç¥é–‹é‹ç¬¦", count: 100, color: "#FF9800", weight: 40 },
            { name: "éŠ˜è¬æƒ é¡§", count: 9999, color: "#607D8B", weight: 80 }
        ];

        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinBtn = document.getElementById('spinBtn');
        const statusMsg = document.getElementById('statusMessage');
        const winSfx = document.getElementById('winSfx');
        const spinSfx = document.getElementById('spinSfx');
        const sadSfx = document.getElementById('sadSfx');
        let isSpinning = false;

        function drawWheel() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 380;
            const totalWeight = prizes.reduce((sum, p) => sum + p.weight, 0);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let startAngle = 0;

            prizes.forEach((prize, i) => {
                const sliceAngle = (2 * Math.PI * prize.weight) / totalWeight;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.fillStyle = prize.color;
                ctx.fill();
                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.stroke();

                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(startAngle + sliceAngle / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#fff";
                let fontSize = Math.min(26, Math.max(12, (sliceAngle * 140)));
                ctx.font = `bold ${fontSize}px sans-serif`;
                ctx.fillText(prize.name + (prize.count < 100 ? ` (${prize.count})` : ""), radius - 40, 10);
                ctx.restore();

                prize.startDeg = (startAngle * 180) / Math.PI;
                prize.endDeg = ((startAngle + sliceAngle) * 180) / Math.PI;
                startAngle += sliceAngle;
            });

            ctx.beginPath(); ctx.arc(centerX, centerY, 55, 0, Math.PI * 2);
            ctx.fillStyle = '#FFD700'; ctx.fill();
            ctx.fillStyle = '#8B0000'; ctx.font = "bold 35px serif"; ctx.textAlign = "center";
            ctx.fillText("ç¦", centerX, centerY + 12);
        }

        function initiateSpin() {
            if (isSpinning) return;
            const pool = prizes.map((p, i) => ({ ...p, idx: i })).filter(p => p.count > 0);
            if (pool.length === 0) return;

            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            let random = Math.random() * totalWeight;
            let winIndex = -1;
            for(let p of pool) {
                if (random < p.weight) { winIndex = p.idx; break; }
                random -= p.weight;
            }

            isSpinning = true;
            spinBtn.disabled = true;
            statusMsg.innerText = "è²¡ç¥çˆºæ­£åœ¨æŒ‘é¸å¹¸é‹å…’...";
            
            // éŸ³æ•ˆé‡å•Ÿèˆ‡åŠ é€Ÿé ç†±
            spinSfx.currentTime = 0;
            spinSfx.playbackRate = 1.2;
            spinSfx.play().catch(() => {});
            winSfx.load(); 
            sadSfx.load();

            const rounds = 10 + Math.floor(Math.random() * 5); // å¢åŠ è½‰å‹•åœˆæ•¸å¢åŠ æœŸå¾…æ„Ÿ
            const winner = prizes[winIndex];
            const targetDeg = (rounds * 360) + (270 - (winner.startDeg + winner.endDeg) / 2);

            canvas.style.transform = `rotate(${targetDeg}deg)`;
            setTimeout(() => finalizeSpin(winIndex), 6000);
        }

        async function finalizeSpin(index) {
            isSpinning = false;
            spinBtn.disabled = false;
            statusMsg.innerText = "";
            spinSfx.pause();

            const winner = prizes[index];
            if (winner.count > 0) winner.count--;

            document.getElementById('winPrizeName').innerText = winner.name;
            const overlay = document.getElementById('overlay');
            const resultIcon = document.getElementById('resultIcon');
            const winTitle = document.getElementById('winTitle');

            // æ—¥æœ¬å¼èª‡å¼µéŸ³æ•ˆè™•ç†
            if (winner.name === "éŠ˜è¬æƒ é¡§") {
                resultIcon.innerText = "ğŸ®";
                winTitle.innerText = "å¯æƒœï¼å¤©æ©Ÿæœªåˆ°";
                winTitle.className = "text-5xl font-black text-gray-400 mt-6 mb-2";
                sadSfx.currentTime = 0;
                sadSfx.play().catch(() => {});
            } else {
                resultIcon.innerText = "ğŸ‰";
                winTitle.innerText = "æ­å–œä¸­å¤§çï¼";
                winTitle.className = "text-6xl font-black gold-text mt-6 mb-2";
                winSfx.currentTime = 0;
                winSfx.play().catch(() => {});
            }

            overlay.style.display = 'flex';
            drawWheel();

            const aiFortune = document.getElementById('aiFortune');
            aiFortune.innerHTML = 'æ­£åœ¨ç‚ºæ‚¨æ‰¹ç®—ä»Šæ—¥è²¡é‹...<div class="flex justify-center gap-1 mt-2"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>';
            
            const prompt = `ä½¿ç”¨è€…æŠ½ä¸­äº†ã€Œ${winner.name}ã€ã€‚è«‹æ‰®æ¼”ä¸€ä½å¹½é»˜è±ªé‚çš„è²¡ç¥çˆºï¼Œæ‰¹ç®—ä»Šæ—¥è²¡é‹ã€‚50å­—ä»¥å…§ã€‚`;
            const fortune = await callGemini(prompt, "ä½ æ˜¯å°ˆæ¥­çš„è²¡ç¥çˆº AIã€‚");
            aiFortune.innerText = fortune;
        }

        async function getAiSuggestions() {
            const output = document.getElementById('aiSuggestionOutput');
            output.innerText = "æ­£åœ¨æ§‹æ€å‰µæ„çé …...";
            const prompt = "è«‹çµ¦æˆ‘ 5 å€‹å°¾ç‰™å‰µæ„çé …åç¨±ã€‚";
            const result = await callGemini(prompt, "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ´»å‹•ä¼åŠƒå°ˆå®¶ã€‚");
            output.innerText = result;
        }

        function closeOverlay() { document.getElementById('overlay').style.display = 'none'; }

        let adminClicks = 0;
        let adminTimer;
        function adminCounter() {
            adminClicks++;
            clearTimeout(adminTimer);
            if (adminClicks >= 5) { openAdmin(); adminClicks = 0; }
            adminTimer = setTimeout(() => { adminClicks = 0; }, 1500); 
        }

        function openAdmin() {
            const listContainer = document.getElementById('adminList');
            listContainer.innerHTML = prizes.map((p, i) => `
                <div class="bg-gray-800 p-3 rounded border-l-4" style="border-color: ${p.color}">
                    <div class="mb-2">
                        <label class="block text-xs text-gray-400">çé …åç¨±</label>
                        <input type="text" data-idx="${i}" data-key="name" value="${p.name}" class="w-full text-yellow-500 font-bold bg-[#333] border-[#444] border p-1 rounded">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs text-gray-400">åº«å­˜</label><input type="number" data-idx="${i}" data-key="count" value="${p.count}" class="w-full bg-[#333] border-[#444] border p-1 rounded"></div>
                        <div><label class="block text-xs text-gray-400">æ¬Šé‡</label><input type="number" data-idx="${i}" data-key="weight" value="${p.weight}" class="w-full bg-[#333] border-[#444] border p-1 rounded"></div>
                    </div>
                </div>
            `).join('');
            document.getElementById('adminModal').style.display = 'block';
        }

        function saveAdminData() {
            document.querySelectorAll('#adminList input').forEach(input => {
                const idx = input.dataset.idx;
                const key = input.dataset.key;
                prizes[idx][key] = (key === 'name') ? input.value : parseInt(input.value);
            });
            drawWheel(); closeAdmin();
            statusMsg.innerText = "âœ… è¨­å®šå·²æ›´æ–°";
            setTimeout(() => statusMsg.innerText = "", 2000);
        }
        function closeAdmin() { document.getElementById('adminModal').style.display = 'none'; }

        window.onload = drawWheel;
    </script>
</body>
</html>