<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¡ç¥åˆ° â€§ AI æ™ºæ…§åŠ æŒæŠ½çç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --gold: #FFD700;
            --crimson: #8B0000;
            --bright-red: #D32F2F;
        }

        body {
            background-color: var(--crimson);
            background-image: radial-gradient(circle, #b71c1c 0%, #5f0000 100%);
            color: white;
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .gold-text {
            color: var(--gold);
            text-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        #wheel-container {
            position: relative;
            width: 90vw;
            max-width: 600px;
            aspect-ratio: 1 / 1;
            margin: 20px auto;
        }

        canvas {
            width: 100%;
            height: 100%;
            border: 12px solid var(--gold);
            border-radius: 50%;
            box-shadow: 0 0 50px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.3);
            transition: transform 6s cubic-bezier(0.15, 0, 0.15, 1);
        }

        .pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 80px;
            z-index: 20;
            filter: drop-shadow(0 4px 10px rgba(0,0,0,0.5));
        }

        .btn-spin {
            background: linear-gradient(180deg, #FFEB3B 0%, #FBC02D 100%);
            border: none;
            box-shadow: 0 8px 0 #C49000, 0 15px 25px rgba(0,0,0,0.3);
            transition: all 0.1s;
        }

        .btn-spin:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #C49000, 0 5px 15px rgba(0,0,0,0.3);
        }

        #overlay {
            display: none;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .celebration-icon {
            font-size: 100px;
            animation: bounce 0.6s infinite alternate;
        }

        @keyframes bounce {
            from { transform: scale(0.8); }
            to { transform: scale(1.2); }
        }

        .admin-trigger {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 80px;
            height: 80px;
            opacity: 0;
            z-index: 999;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            z-index: 2000;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* AI è¼‰å…¥å‹•ç•« */
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--gold);
            border-radius: 50%;
            display: inline-block;
            animation: typing 1s infinite ease-in-out;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <header class="text-center my-8">
        <h1 class="text-5xl md:text-7xl font-black gold-text mb-2">ğŸ§§ è²¡ç¥æŠ½å¤§ç ğŸ§§</h1>
        <p class="text-xl text-yellow-100 opacity-80">AI æ™ºæ…§é–‹é‹ â€§ è¦–è¦ºå³æ©Ÿç‡</p>
    </header>

    <div id="wheel-container">
        <svg class="pointer" viewBox="0 0 100 120">
            <path d="M50 120 L0 20 A50 50 0 1 1 100 20 Z" fill="#FFD700" stroke="#B8860B" stroke-width="2"/>
            <circle cx="50" cy="40" r="10" fill="#D32F2F" />
        </svg>
        <canvas id="wheelCanvas" width="800" height="800"></canvas>
    </div>

    <div class="mt-8 w-full max-w-md text-center">
        <button id="spinBtn" onclick="initiateSpin()" class="btn-spin w-full py-6 px-12 rounded-full text-4xl font-bold text-red-900">
            é»æˆ‘æ†‘é‹æ°£
        </button>
        <div id="statusMessage" class="mt-6 text-2xl font-semibold text-yellow-400 h-8"></div>
    </div>

    <!-- ä¸­ç/çµæœå½ˆçª— -->
    <div id="overlay" class="fixed inset-0 flex flex-col items-center justify-center p-6 text-center overflow-y-auto">
        <div class="celebration-icon" id="resultIcon">ğŸŠ</div>
        <h2 class="text-5xl font-black gold-text mt-6 mb-2" id="winTitle">æ­å–œä¸­çï¼</h2>
        <p id="winPrizeName" class="text-3xl text-white font-bold mb-4"></p>
        
        <!-- AI è²¡ç¥éˆç±¤å€ -->
        <div class="bg-red-900/50 border border-yellow-600/30 p-4 rounded-xl max-w-sm mb-8">
            <h4 class="text-yellow-500 font-bold mb-2">âœ¨ è²¡ç¥çˆºéˆç±¤æ‰¹ç®— âœ¨</h4>
            <div id="aiFortune" class="text-lg text-yellow-100 italic leading-relaxed">
                æ­£åœ¨ææŒ‡ä¸€ç®—...
                <div class="flex justify-center gap-1 mt-2">
                    <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
                </div>
            </div>
        </div>

        <button onclick="closeOverlay()" class="bg-yellow-500 hover:bg-yellow-400 text-red-900 font-bold py-4 px-10 rounded-full text-xl transition">
            è¬ä¸»éš†æ©
        </button>
    </div>

    <div class="admin-trigger" onclick="adminCounter()"></div>

    <!-- ç®¡ç†å¾Œå° -->
    <div id="adminModal" class="modal shadow-2xl border border-yellow-600">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold gold-text">çé …èˆ‡æ¯”ä¾‹ç®¡ç†</h3>
            <button onclick="closeAdmin()" class="text-gray-400 text-3xl">&times;</button>
        </div>
        
        <div class="bg-blue-900/30 p-3 rounded mb-6 border border-blue-500/30">
            <div class="flex items-center justify-between mb-2">
                <span class="text-blue-300 font-bold">âœ¨ AI æ™ºæ…§çé …å»ºè­°</span>
                <button onclick="getAiSuggestions()" class="bg-blue-600 hover:bg-blue-500 text-xs py-1 px-3 rounded">ç”Ÿæˆéˆæ„Ÿ</button>
            </div>
            <p id="aiSuggestionOutput" class="text-xs text-gray-400 leading-tight">æƒ³è¦æ›´æœ‰å‰µæ„çš„çå“åç¨±ï¼Ÿé»æ“Šä¸Šæ–¹ç”ŸæˆæŒ‰éˆ•ã€‚</p>
        </div>

        <div id="adminList" class="space-y-4"></div>
        <div class="mt-8 flex gap-2">
            <button onclick="saveAdminData()" class="flex-1 bg-green-600 py-3 rounded font-bold">å„²å­˜è¨­å®š</button>
            <button onclick="closeAdmin()" class="flex-1 bg-gray-700 py-3 rounded font-bold">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- Gemini API æ•´åˆ ---
        const apiKey = "";
        
        async function callGemini(prompt, systemPrompt = "") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('API Error');
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "è²¡ç¥çˆºç¾åœ¨æœ‰é»å¿™ï¼Œç¨å¾Œå†ç‚ºæ‚¨æ‰¹ç®—ã€‚";
                } catch (e) {
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            return "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---
        let prizes = [
            { name: "iPhone 16 Pro", count: 1, color: "#D4AF37", weight: 2 },
            { name: "ç¾é‡‘ 8888", count: 3, color: "#E91E63", weight: 8 },
            { name: "è¶…å¸‚ç¦®åˆ¸", count: 10, color: "#4CAF50", weight: 15 },
            { name: "å“ç‰Œä¿æº«ç“¶", count: 20, color: "#2196F3", weight: 25 },
            { name: "è²¡ç¥é–‹é‹ç¬¦", count: 100, color: "#FF9800", weight: 40 },
            { name: "éŠ˜è¬æƒ é¡§", count: 9999, color: "#607D8B", weight: 80 }
        ];

        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinBtn = document.getElementById('spinBtn');
        const statusMsg = document.getElementById('statusMessage');
        let isSpinning = false;

        function drawWheel() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 380;
            const totalWeight = prizes.reduce((sum, p) => sum + p.weight, 0);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let startAngle = 0;

            prizes.forEach((prize, i) => {
                const sliceAngle = (2 * Math.PI * prize.weight) / totalWeight;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.fillStyle = prize.color;
                ctx.fill();
                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.stroke();

                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(startAngle + sliceAngle / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#fff";
                let fontSize = Math.min(28, Math.max(12, (sliceAngle * 150)));
                ctx.font = `bold ${fontSize}px sans-serif`;
                ctx.fillText(prize.name + (prize.count < 100 ? ` (${prize.count})` : ""), radius - 40, 10);
                ctx.restore();

                prize.startDeg = (startAngle * 180) / Math.PI;
                prize.endDeg = ((startAngle + sliceAngle) * 180) / Math.PI;
                startAngle += sliceAngle;
            });

            // ä¸­å¿ƒè£é£¾
            ctx.beginPath(); ctx.arc(centerX, centerY, 55, 0, Math.PI * 2);
            ctx.fillStyle = '#FFD700'; ctx.fill();
            ctx.fillStyle = '#8B0000'; ctx.font = "bold 35px serif"; ctx.textAlign = "center";
            ctx.fillText("ç¦", centerX, centerY + 12);
        }

        function initiateSpin() {
            if (isSpinning) return;
            const pool = prizes.map((p, i) => ({ ...p, idx: i })).filter(p => p.count > 0);
            if (pool.length === 0) return;

            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            let random = Math.random() * totalWeight;
            let winIndex = -1;
            for(let p of pool) {
                if (random < p.weight) { winIndex = p.idx; break; }
                random -= p.weight;
            }

            isSpinning = true;
            spinBtn.disabled = true;
            statusMsg.innerText = "è²¡ç¥çœ·é¡§ä¸­...";

            const rounds = 8 + Math.floor(Math.random() * 5);
            const winner = prizes[winIndex];
            const targetDeg = (rounds * 360) + (270 - (winner.startDeg + winner.endDeg) / 2);

            canvas.style.transform = `rotate(${targetDeg}deg)`;
            setTimeout(() => finalizeSpin(winIndex), 6000);
        }

        async function finalizeSpin(index) {
            isSpinning = false;
            spinBtn.disabled = false;
            statusMsg.innerText = "";

            const winner = prizes[index];
            if (winner.count > 0) winner.count--;

            // æ›´æ–° UI
            document.getElementById('winPrizeName').innerText = winner.name;
            const overlay = document.getElementById('overlay');
            const resultIcon = document.getElementById('resultIcon');
            const winTitle = document.getElementById('winTitle');
            const aiFortune = document.getElementById('aiFortune');

            if (winner.name === "éŠ˜è¬æƒ é¡§") {
                resultIcon.innerText = "ğŸ®";
                winTitle.innerText = "å†æ¥å†å²";
                winTitle.className = "text-5xl font-black text-gray-300 mt-6 mb-2";
            } else {
                resultIcon.innerText = "ğŸŠ";
                winTitle.innerText = "æ­å–œä¸­çï¼";
                winTitle.className = "text-5xl font-black gold-text mt-6 mb-2";
            }

            overlay.style.display = 'flex';
            drawWheel();

            // âœ¨ AI ç”Ÿæˆéˆç±¤
            aiFortune.innerHTML = 'æ­£åœ¨ææŒ‡ä¸€ç®—...<div class="flex justify-center gap-1 mt-2"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>';
            
            const prompt = `ä½¿ç”¨è€…å‰›åœ¨æŠ½çä¸­ç²å¾—äº†ã€Œ${winner.name}ã€ã€‚è«‹æ‰®æ¼”ä¸€ä½å¹½é»˜é¢¨è¶£çš„æ±æ–¹è²¡ç¥çˆºï¼Œæ ¹æ“šé€™å€‹çµæœæ‰¹ç®—ä»–ä»Šæ—¥çš„è²¡é‹ã€‚
            å¦‚æœæ˜¯å¤§çè¦æ¥µåŠ›èª‡è®šï¼Œå¦‚æœæ˜¯å°çè¦çµ¦äºˆé¼“å‹µï¼Œå¦‚æœæ˜¯éŠ˜è¬æƒ é¡§è¦ç”¨å¹½é»˜çš„æ–¹å¼åŒ–è§£å°·å°¬ä¸¦çµ¦äºˆè½‰é‹å»ºè­°ã€‚å­—æ•¸ç´„ 50-80 å­—ï¼Œå……æ»¿å–œæ°£ã€‚`;
            const systemPrompt = "ä½ æ˜¯å°ˆæ¥­çš„è²¡ç¥çˆº AIï¼Œèªªè©±èªæ°£è¦è±ªé‚ã€å‰ç¥¥ã€å¯Œæœ‰ç¦ªæ„ä¸”å¹½é»˜ã€‚";
            
            const fortune = await callGemini(prompt, systemPrompt);
            aiFortune.innerText = fortune;
        }

        // âœ¨ AI çé …éˆæ„Ÿå»ºè­°
        async function getAiSuggestions() {
            const output = document.getElementById('aiSuggestionOutput');
            output.innerText = "æ­£åœ¨æ§‹æ€å‰µæ„çé …...";
            
            const prompt = "è«‹å¹«æˆ‘è¨­è¨ˆ 5 å€‹é©åˆå°¾ç‰™æˆ–æ˜¥ç¯€æŠ½ççš„ã€Œå‰µæ„çé …åç¨±ã€èˆ‡å°æ‡‰çš„ã€Œä¸­çæè¿°ã€ã€‚è¦æœ‰æ¢—ã€å¥½ç¬‘ä¸”ç¬¦åˆç¯€æ…¶æ°£æ°›ã€‚ä¾‹å¦‚ï¼šç‰¹çã€Œé€™ä¸æ˜¯å¤¢ iPhoneã€ã€æ™®çã€Œè€é—†è«‹å–å¤§å†°å¥¶ã€ã€‚";
            const result = await callGemini(prompt, "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ´»å‹•ç­–åŠƒå¤§å¸«ï¼Œæ“…é•·å‘½åèˆ‡æ–‡æ¡ˆæ’°å¯«ã€‚");
            output.innerText = result;
        }

        function closeOverlay() { document.getElementById('overlay').style.display = 'none'; }

        // ç®¡ç†é¢æ¿é‚è¼¯
        let adminClicks = 0;
        let adminTimer;
        function adminCounter() {
            adminClicks++;
            clearTimeout(adminTimer);
            if (adminClicks >= 5) { openAdmin(); adminClicks = 0; }
            adminTimer = setTimeout(() => { adminClicks = 0; }, 1000);
        }

        function openAdmin() {
            const listContainer = document.getElementById('adminList');
            listContainer.innerHTML = prizes.map((p, i) => `
                <div class="bg-gray-800 p-3 rounded border-l-4" style="border-color: ${p.color}">
                    <div class="font-bold text-yellow-500 mb-2">${p.name}</div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs text-gray-400">åº«å­˜</label><input type="number" data-idx="${i}" data-key="count" value="${p.count}" class="w-full bg-gray-700 p-1 rounded"></div>
                        <div><label class="block text-xs text-gray-400">æ¬Šé‡</label><input type="number" data-idx="${i}" data-key="weight" value="${p.weight}" class="w-full bg-gray-700 p-1 rounded"></div>
                    </div>
                </div>
            `).join('');
            document.getElementById('adminModal').style.display = 'block';
        }

        function saveAdminData() {
            document.querySelectorAll('#adminList input').forEach(input => {
                prizes[input.dataset.idx][input.dataset.key] = parseInt(input.value);
            });
            drawWheel(); closeAdmin();
        }
        function closeAdmin() { document.getElementById('adminModal').style.display = 'none'; }

        window.onload = drawWheel;
    </script>
</body>
</html>