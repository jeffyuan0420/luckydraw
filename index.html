<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¡ç¥åˆ° â€§ æ—¥æœ¬å•†åº—è¡—é¢¨ AI æ™ºæ…§æŠ½çç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --gold: #FFD700;
            --crimson: #8B0000;
            --bright-red: #D32F2F;
        }

        body {
            background-color: var(--crimson);
            background-image: radial-gradient(circle, #b71c1c 0%, #5f0000 100%);
            color: white;
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .gold-text {
            color: var(--gold);
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        #wheel-container {
            position: relative;
            width: 90vw;
            max-width: 600px;
            aspect-ratio: 1 / 1;
            margin: 20px auto;
        }

        canvas {
            width: 100%;
            height: 100%;
            border: 12px solid var(--gold);
            border-radius: 50%;
            box-shadow: 0 0 60px rgba(0,0,0,0.6), inset 0 0 30px rgba(0,0,0,0.3);
            /* èª¿æ•´ç‚ºæ›´å¹³æ»‘ä½†æœ‰åŠ›çš„å‹•åŠ›æ›²ç·š */
            transition: transform 7s cubic-bezier(0.2, 0, 0, 1);
        }

        .pointer {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 90px;
            z-index: 30;
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.6));
        }

        .btn-spin {
            background: linear-gradient(180deg, #FFEB3B 0%, #FBC02D 100%);
            border: none;
            box-shadow: 0 8px 0 #C49000, 0 15px 30px rgba(0,0,0,0.4);
            transition: all 0.1s;
        }

        .btn-spin:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #C49000;
        }

        #overlay {
            display: none;
            background: rgba(0, 0, 0, 0.96);
            backdrop-filter: blur(8px);
            z-index: 5000;
        }

        .admin-trigger {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 150px;
            height: 150px;
            background: transparent;
            z-index: 999999; 
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a1a;
            padding: 2rem;
            border-radius: 1.5rem;
            width: 95%;
            max-width: 550px;
            z-index: 6000;
            max-height: 85vh;
            overflow-y: auto;
            border: 3px solid var(--gold);
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            background: var(--gold);
            border-radius: 50%;
            display: inline-block;
            animation: typing 0.8s infinite ease-in-out;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.1s; }
        .typing-dot:nth-child(3) { animation-delay: 0.2s; }

        @keyframes typing {
            0%, 100% { transform: translateY(0); opacity: 0.3; }
            50% { transform: translateY(-12px); opacity: 1; }
        }

        input {
            color: #fff;
            background: #2a2a2a;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 6px;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4 select-none">

    <header class="text-center my-8">
        <h1 class="text-5xl md:text-7xl font-black gold-text mb-2 tracking-tighter">ğŸ§§ è²¡ç¥æŠ½å¤§ç ğŸ§§</h1>
        <p class="text-xl text-yellow-100 opacity-90">æ¥µè‡´å‹•åŠ›æ„Ÿ â€§ æ—¥æœ¬é–‹çæ•ˆæœ</p>
    </header>

    <div id="wheel-container">
        <svg class="pointer" viewBox="0 0 100 120">
            <path d="M50 120 L0 20 A50 50 0 1 1 100 20 Z" fill="#FFD700" stroke="#B8860B" stroke-width="3"/>
            <circle cx="50" cy="40" r="12" fill="#D32F2F" />
        </svg>
        <canvas id="wheelCanvas" width="800" height="800"></canvas>
    </div>

    <div class="mt-8 w-full max-w-md text-center">
        <button id="spinBtn" onclick="initiateSpin()" class="btn-spin w-full py-6 px-12 rounded-full text-4xl font-black text-red-900 shadow-2xl">
            é»æˆ‘æŠ½å¥½é‹
        </button>
        <div id="statusMessage" class="mt-6 text-2xl font-bold text-yellow-400 h-8"></div>
    </div>

    <div id="overlay" class="fixed inset-0 flex flex-col items-center justify-center p-6 text-center overflow-y-auto">
        <div class="text-[120px] mb-4" id="resultIcon">ğŸŠ</div>
        <h2 class="text-7xl font-black gold-text mb-4" id="winTitle">æ­å–œä¸­çï¼</h2>
        <p id="winPrizeName" class="text-5xl text-white font-bold mb-8"></p>
        
        <div class="bg-red-950/80 border-2 border-yellow-600/50 p-6 rounded-2xl max-w-md mb-10 shadow-2xl">
            <h4 class="text-yellow-500 font-black text-xl mb-4 tracking-widest">âœ¨ è²¡ç¥çˆºé–‹é‡‘å£ âœ¨</h4>
            <div id="aiFortune" class="text-2xl text-yellow-500 italic leading-snug font-medium min-h-[80px]">
                æ­£åœ¨ç‚ºæ‚¨æ‰¹ç®—...
                <div class="flex justify-center gap-2 mt-4">
                    <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
                </div>
            </div>
        </div>

        <button onclick="closeOverlay()" class="bg-yellow-500 hover:bg-yellow-400 text-red-900 font-black py-5 px-16 rounded-full text-3xl shadow-2xl transition-all hover:scale-110 active:scale-90">
            è¬ä¸»éš†æ©
        </button>
    </div>

    <div class="admin-trigger" onclick="adminCounter()"></div>

    <div id="adminModal" class="modal">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-3xl font-bold gold-text">çé …èˆ‡æ¯”ä¾‹è¨­å®š</h3>
            <button onclick="closeAdmin()" class="text-gray-400 text-4xl">&times;</button>
        </div>
        <div id="adminList" class="space-y-4"></div>
        <div class="mt-10 flex gap-4">
            <button onclick="saveAdminData()" class="flex-1 bg-green-600 hover:bg-green-500 py-4 rounded-xl font-black text-xl text-white shadow-xl">å„²å­˜ä¸¦é‡å•Ÿ</button>
            <button onclick="closeAdmin()" class="flex-1 bg-gray-700 py-4 rounded-xl font-bold text-xl text-white">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- éŸ³æ•ˆè³‡æºï¼šæ›´æ–°ç‚ºé«˜æˆ²åŠ‡åº¦ç´ æ -->
    <audio id="spinSfx" src="https://assets.mixkit.co/active_storage/sfx/2005/2005-preview.mp3" preload="auto" loop></audio>
    <!-- ä¸­çï¼šæ›æˆæ›´æœ‰ç¯€æ…¶æ„Ÿçš„ Fanfare -->
    <audio id="winSfx" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" preload="auto"></audio>
    <!-- è½é¸ï¼šæ›æˆæ›´æ»‘ç¨½çš„è²éŸ³ -->
    <audio id="sadSfx" src="https://assets.mixkit.co/active_storage/sfx/255/255-preview.mp3" preload="auto"></audio>

    <script>
        const apiKey = "AIzaSyAK-ZGGxlPvM83SwdDEtaBK_3C7yS-WKvw"; 
        
        async function callGemini(prompt, systemPrompt = "") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return text || "ã€è²¡ç¥æ‚„æ‚„è©±ã€‘ï¼šä»Šæ—¥å¤§å‰å¤§åˆ©ï¼";
            } catch (e) {
                return "ã€è²¡ç¥çˆºéˆç±¤ã€‘ï¼šé´»é‹é½Šå¤©ï¼Œå¥½é‹å¿…å°‡é™è‡¨ï¼";
            }
        }

        let prizes = [
            { name: "iPhone 16 Pro", count: 1, color: "#D4AF37", weight: 2 },
            { name: "ç¾é‡‘ 8888", count: 3, color: "#E91E63", weight: 8 },
            { name: "è¶…å¸‚ç¦®åˆ¸", count: 10, color: "#4CAF50", weight: 15 },
            { name: "å“ç‰Œä¿æº«ç“¶", count: 20, color: "#2196F3", weight: 25 },
            { name: "è²¡ç¥é–‹é‹ç¬¦", count: 100, color: "#FF9800", weight: 40 },
            { name: "éŠ˜è¬æƒ é¡§", count: 9999, color: "#607D8B", weight: 80 }
        ];

        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinBtn = document.getElementById('spinBtn');
        const statusMsg = document.getElementById('statusMessage');
        const winSfx = document.getElementById('winSfx');
        const spinSfx = document.getElementById('spinSfx');
        const sadSfx = document.getElementById('sadSfx');
        
        let currentRotation = 0; // å…¨åŸŸè¿½è¹¤æ—‹è½‰è§’åº¦
        let isSpinning = false;

        function drawWheel() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 380;
            const totalWeight = prizes.reduce((sum, p) => sum + p.weight, 0);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let startAngle = 0;

            prizes.forEach((prize) => {
                const sliceAngle = (2 * Math.PI * prize.weight) / totalWeight;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.fillStyle = prize.color;
                ctx.fill();
                ctx.strokeStyle = 'rgba(255,255,255,0.4)';
                ctx.stroke();

                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(startAngle + sliceAngle / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#fff";
                let fontSize = Math.min(28, Math.max(12, (sliceAngle * 150)));
                ctx.font = `bold ${fontSize}px sans-serif`;
                ctx.fillText(prize.name + (prize.count < 100 ? ` (${prize.count})` : ""), radius - 40, 10);
                ctx.restore();

                prize.startDeg = (startAngle * 180) / Math.PI;
                prize.endDeg = ((startAngle + sliceAngle) * 180) / Math.PI;
                startAngle += sliceAngle;
            });

            ctx.beginPath(); ctx.arc(centerX, centerY, 60, 0, Math.PI * 2);
            ctx.fillStyle = '#FFD700'; ctx.fill();
            ctx.fillStyle = '#8B0000'; ctx.font = "bold 40px serif"; ctx.textAlign = "center";
            ctx.fillText("ç¦", centerX, centerY + 14);
        }

        function initiateSpin() {
            if (isSpinning) return;
            const pool = prizes.map((p, i) => ({ ...p, idx: i })).filter(p => p.count > 0);
            if (pool.length === 0) return;

            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            let random = Math.random() * totalWeight;
            let winIndex = -1;
            for(let p of pool) {
                if (random < p.weight) { winIndex = p.idx; break; }
                random -= p.weight;
            }

            isSpinning = true;
            spinBtn.disabled = true;
            statusMsg.innerText = "è²¡ç¥çˆºæŒ‘é¸ä¸­...";
            
            // å¼·åˆ¶é‡ç½®éŸ³æ•ˆä¸¦åŠ é€Ÿæ’­æ”¾
            spinSfx.currentTime = 0;
            spinSfx.playbackRate = 1.6; // æé«˜è½‰é€ŸéŸ³æ•ˆé »ç‡
            spinSfx.play().catch(() => {});
            winSfx.load(); sadSfx.load();

            // ä¿®æ­£æ—‹è½‰é‚è¼¯ï¼šæ¯æ¬¡æ—‹è½‰åŸºç¤å¢åŠ  20 åœˆï¼Œè§£æ±ºè½‰é€Ÿä¸‹é™å•é¡Œ
            const baseRounds = 20; 
            const winner = prizes[winIndex];
            const centerOfSlice = (winner.startDeg + winner.endDeg) / 2;
            
            // è¨ˆç®—ç•¶å‰è§’åº¦ä¸‹ï¼Œè¦è½‰åˆ°ç›®æ¨™çé …éœ€è¦çš„é¡å¤–åº¦æ•¸
            // æˆ‘å€‘è¦æŠŠæŒ‡é‡ (270åº¦) å°æº–çé …ä¸­å¿ƒ
            const currentMod = currentRotation % 360;
            const extraDeg = (270 - centerOfSlice - currentMod + 1440) % 360;
            
            const totalSpinDeg = (baseRounds * 360) + extraDeg;
            currentRotation += totalSpinDeg;

            canvas.style.transform = `rotate(${currentRotation}deg)`;
            setTimeout(() => finalizeSpin(winIndex), 7000);
        }

        async function finalizeSpin(index) {
            isSpinning = false;
            spinBtn.disabled = false;
            statusMsg.innerText = "";
            spinSfx.pause();

            const winner = prizes[index];
            if (winner.count > 0) winner.count--;

            document.getElementById('winPrizeName').innerText = winner.name;
            const overlay = document.getElementById('overlay');
            const resultIcon = document.getElementById('resultIcon');
            const winTitle = document.getElementById('winTitle');

            if (winner.name === "éŠ˜è¬æƒ é¡§") {
                resultIcon.innerText = "ğŸ®";
                winTitle.innerText = "å¯æƒœï¼å¤©æ©Ÿæœªåˆ°";
                winTitle.className = "text-5xl font-black text-gray-500 mt-6 mb-2";
                sadSfx.currentTime = 0; sadSfx.play();
            } else {
                resultIcon.innerText = "ğŸŠ";
                winTitle.innerText = "æ­å–œä¸­å¤§çï¼";
                winTitle.className = "text-7xl font-black gold-text mt-6 mb-2 animate-pulse";
                winSfx.currentTime = 0; winSfx.play();
            }

            overlay.style.display = 'flex';
            drawWheel();

            const aiFortune = document.getElementById('aiFortune');
            aiFortune.innerHTML = 'æ­£åœ¨é–‹é‡‘å£...<div class="flex justify-center gap-2 mt-4"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>';
            
            const prompt = `ä½¿ç”¨è€…æŠ½ä¸­äº†ã€Œ${winner.name}ã€ã€‚è«‹æ‰®æ¼”ä¸€ä½æ¥µåº¦è±ªé‚çš„è²¡ç¥çˆºï¼Œçµ¦ä»–ä¸€æ®µç†±æƒ…çš„è²¡é‹é æ¸¬ã€‚å­—æ•¸50å­—ã€‚`;
            const fortune = await callGemini(prompt, "ä½ æ˜¯å°ˆæ¥­çš„è²¡ç¥çˆº AIã€‚");
            aiFortune.innerText = fortune;
        }

        function closeOverlay() { document.getElementById('overlay').style.display = 'none'; }

        let adminClicks = 0;
        let adminTimer;
        function adminCounter() {
            adminClicks++;
            clearTimeout(adminTimer);
            if (adminClicks >= 5) { openAdmin(); adminClicks = 0; }
            adminTimer = setTimeout(() => { adminClicks = 0; }, 1500); 
        }

        function openAdmin() {
            const listContainer = document.getElementById('adminList');
            listContainer.innerHTML = prizes.map((p, i) => `
                <div class="bg-gray-800 p-4 rounded-xl border-l-8" style="border-color: ${p.color}">
                    <div class="mb-3">
                        <label class="block text-sm text-gray-400">çé …åç¨±</label>
                        <input type="text" data-idx="${i}" data-key="name" value="${p.name}" class="w-full text-yellow-400 font-black text-lg">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400">åº«å­˜</label><input type="number" data-idx="${i}" data-key="count" value="${p.count}" class="w-full font-bold"></div>
                        <div><label class="block text-sm text-gray-400">æ¬Šé‡</label><input type="number" data-idx="${i}" data-key="weight" value="${p.weight}" class="w-full font-bold"></div>
                    </div>
                </div>
            `).join('');
            document.getElementById('adminModal').style.display = 'block';
        }

        function saveAdminData() {
            document.querySelectorAll('#adminList input').forEach(input => {
                const idx = input.dataset.idx;
                const key = input.dataset.key;
                prizes[idx][key] = (key === 'name') ? input.value : parseInt(input.value);
            });
            drawWheel(); closeAdmin();
            statusMsg.innerText = "âœ… è¨­å®šå·²æ›´æ–°";
            setTimeout(() => statusMsg.innerText = "", 2000);
        }
        function closeAdmin() { document.getElementById('adminModal').style.display = 'none'; }

        window.onload = drawWheel;
    </script>
</body>
</html>